<!doctype html><html><head><title>Deploying WordPress with Ansible</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link rel=stylesheet href=/css/flag-icon.min.css><link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><meta property="og:title" content="Deploying WordPress with Ansible"><meta property="og:description" content="Ansible is a framework for automating deployment and maintenance of remote systems. This tutorial will go through the creation of my own WordPress playbook for Ansible. You can find all of my WordPress playbooks in Github in my Playbooks repository.
wp_install.yml playbook The WordPress installer playbook I created is the wp_install.yml playbook. The playbook handles the installation and configuration of Apache, MySQL, PHP, and WordPress on top of an Ubuntu server (Tested on 22."><meta property="og:type" content="article"><meta property="og:url" content="https://resettech.net/posts/ansible/wordpress_deploy/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-04-13T00:00:00+00:00"><meta property="article:modified_time" content="2022-04-13T00:00:00+00:00"><meta name=description content="Deploying WordPress with Ansible"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><link rel=stylesheet href=/css/style.css><script async src="https://www.googletagmanager.com/gtag/js?id=G-KLVVMMV4CY"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-KLVVMMV4CY",{anonymize_ip:!1})}</script></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/>Reset_Smith's Blog</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><i class="fas fa-plus-circle"></i><a href=/posts/server_mgmt/>Server Management</a><ul><li><a href=/posts/server_mgmt/htpasswd/ title="Basic Auth with Apache">Basic Auth with Apache</a></li><li><a href=/posts/server_mgmt/add_ssl/ title="Enabling SSL">Enabling SSL</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/wordpress/>WordPress</a><ul><li><a href=/posts/wordpress/lamp_22/ title="Deploying a LAMP server Ubuntu 22.04">Deploying a LAMP server Ubuntu 22.04</a></li><li><a href=/posts/wordpress/migration/ title="WordPress Migrations">WordPress Migrations</a></li><li><a href=/posts/wordpress/lamp/ title="Deploying a LAMP server Ubuntu 20.04">Deploying a LAMP server Ubuntu 20.04</a></li></ul></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/ansible/>Ansible</a><ul class=active><li><a class=active href=/posts/ansible/wordpress_deploy/ title="Ansible Backups">Ansible Backups</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/monitoring/>Monitoring</a><ul><li><a href=/posts/monitoring/prom_install/ title="Getting started">Getting started</a></li><li><a href=/posts/monitoring/node_exporter/ title="Node exporter">Node exporter</a></li><li><a href=/posts/monitoring/blackbox/ title="Blackbox exporter">Blackbox exporter</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://resettech.net/images/default-hero.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/authors/reset_smith_hua4f6218794f907357bf1ed85aa384e41_361770_120x120_fit_q75_box.jpg alt="Author Image"><h5 class=author-name>Reset_Smith</h5><p>April 13, 2022</p></div><div class=title><h1>Deploying WordPress with Ansible</h1></div><div class=post-content id=post-content><p>Ansible is a framework for automating deployment and maintenance of remote systems. This tutorial will go through the creation of my own WordPress playbook for Ansible. You can find all of my WordPress playbooks in Github in my <a href=https://github.com/ResetSmith/playbooks>Playbooks repository</a>.</p><h2 id=wp_installyml-playbook>wp_install.yml playbook</h2><p>The WordPress installer playbook I created is the wp_install.yml playbook. The playbook handles the installation and configuration of Apache, MySQL, PHP, and WordPress on top of an Ubuntu server (Tested on 22.04). This playbook is friendly to being run on multiple targets at once as long as the prerequisites have been completed.</p><p>This tutorial will go through the playbook in sections, but you can find a complete copy of the <a href=https://github.com/ResetSmith/playbooks/blob/main/wordpress/wp_install.yml>playbook in Github</a>.</p><p>Starting from the top there is the section containing the Inventory File and Variable definitions along with the first directive to run the playbook as Sudo.</p><pre tabindex=0><code>---
- hosts: all
  become: true
  vars_files:
    - ../secrets/mysql_vars.yml
</code></pre><p>So for this playbook I have the hosts set to &lsquo;all&rsquo;. I do have my Ansible hosts file setup for different groups but by-and-large the bulk of my servers are WordPress servers so I leave the hosts directive set to &lsquo;all&rsquo; so this playbook will happily run on any server I target regardless of it&rsquo;s group within the hosts file. The &lsquo;become: true&rsquo; directive is about running commands as Sudo, and running it at this level applies Sudo to every task below. This is one of my first playbooks I wrote, and since then have gotten away from applying Sudo at this level, and instead prefer to add this directive to the particular tasks that actually need it. At some point I will revisit this playbook and update the Sudo method but for now this works, and you just need to recognize that all the tasks below will be performed as Sudo. The &lsquo;vars_files:&rsquo; directive looks at a Variable file I have saved in another location. If you are following my same Playbook folder organization the &lsquo;mysql_vars.yml&rsquo; file should be located in /playbooks/secrets/mysql_vars.yml, which you will need to create if you have cloned by playbooks from github. The vars file contains the variables needed for the Geerlingguy.mysql role we&rsquo;ll be running later. But below is an example of what that file should look like, I&rsquo;ll go into more detail further on.</p><pre tabindex=0><code># These are the variables needed for the GeerlingGuy MySQL role

# MySQL root access password
mysql_root_password: $MYSQL_PASSWORD
# Uncomment the line below if you need to overwrite an existing root user password
# mysql_root_password_update: true
mysql_enabled_on_startup: true

# This creates the database needed for WordPress
mysql_databases:
  - {name: &#39;wordpress&#39;, encoding: &#39;utf8&#39;, collation: &#39;utf8_general_ci&#39;}

# This creates the user WordPress will use to access the database
mysql_users:
  - {name: &#39;$WP_USER_NAME&#39;, password: &#39;#WP_USER_PASSWORD&#39;, host: &#39;%&#39;, priv: &#39;wordpress.*:ALL&#39;}
</code></pre><p>That&rsquo;s it for the &lsquo;header&rsquo; section of the wp_install, next up is the &lsquo;Tasks&rsquo; section. The Tasks section of the playbook is list of directives that are actually taking some kind of action. This will become more clear as you review the directives themselves.</p><pre tabindex=0><code>  tasks:
# Checks for server updates and runs them
    - name: Updating apt repo and cache on all servers
      apt: update_cache=yes force_apt_get=yes cache_valid_time=3600

    - name: Updating packages
      apt: upgrade=dist force_apt_get=yes
</code></pre><p>This is the start of our Ansible playbooks tasks section, as you can tell by the &rsquo;tasks:&rsquo; directive and underneath that the tasks are listed out in order that they should run. The first of these two tasks checks for updates, the &lsquo;cache_valid_time&rsquo; directive says that if the last check for updates occurred in the last 3600 seconds (60 minutes) then do not pull updates from the web/repos. The second task here simply installs the updates found by the previous task.</p><pre tabindex=0><code># Installs dependencies needed for WordPress: Apache, MySQL and PHP
    - name: Installing Apache and PHP
      apt: name={{ item }} update_cache=yes state=latest
      loop: [ &#39;apache2&#39;, &#39;python3-pymysql&#39;, &#39;php&#39;, &#39;php-mysql&#39;, &#39;libapache2-mod-php&#39; ]
# Installs PHP extensions needed for WordPress
    - name: Installing PHP extensions
      apt: name={{ item }} update_cache=yes state=latest
      loop: [ &#39;php-curl&#39;, &#39;php-gd&#39;, &#39;php-mbstring&#39;, &#39;php-xml&#39;, &#39;php-xmlrpc&#39;, &#39;php-soap&#39;, &#39;php-intl&#39;, &#39;php-zip&#39;, &#39;php-imagick&#39; ]
# Restarts the system prior to running the geerlingguy.mysql role
    - name: Restarting system prior to running Geerlingguy.MySQL role
      reboot:
        connect_timeout: 5
        reboot_timeout: 300
        post_reboot_delay: 30
        test_command: uptime
</code></pre><p>Now that we have the updates out of the way the next two tasks take care of installing some of the necessary dependencies for a WordPress installation. The first task installs Apache2 and PHP, along with the python3 MySQL Driver, the PHP MySQL module, and the PHP module for Apache2. The second task installs the PHP plugins needed by WordPress. The final task in this sequence reboots the server prior to moving on to the next tasks. I&rsquo;ve found this restart is necessary to prevent errors further into the installation.</p><pre tabindex=0><code># Uses the pre-created role by GeerlingGuy to install mysql
# The role is installed by Ansible in the &#39;/etc/ansible/galaxy.roles/&#39; folder
# Variables needed for this role are defined in &#39;/etc/ansible/playbooks/secrets/mysql_vars.yml&#39;
    - name: Using geerlingguy.mysql role to install and configure mysql
      include_role:
        name: geerlingguy.mysql
</code></pre><p>After the restart the next Task is to install MySQL. I had quite a bit of trouble getting the MySQL installation to work correctly via Ansible, and eventually settled on using an Ansible Role for MySQL installations created by <a href=https://github.com/geerlingguy>Jeff Geerling</a> who has written many Ansible Roles for public use. The specific role I am using here is <a href=https://github.com/geerlingguy/ansible-role-mysql>Ansible-role-mysql</a>. You will need to have downloaded and installed this role prior to running this playbook, along with creating the necessary variable file created at the start of this tutorial. The MySQL role has quite a few tasks to go through, so just let it do it&rsquo;s thing and once completed the playbook will move on the next tasks.</p><pre tabindex=0><code># Apache Configuration
# Creates Apache VirtualHost file, using the ansible hostname
# The ansible hostname is determined automatically from the server&#39;s hostname
# The server&#39;s hostname is set during creation in DigitalOcean or by using the &#39;hostnamectl&#39; command on the server prior to running this playbook
    - name: Creating the Apache VirtualHost file
      template:
        src: &#34;files/apache.conf.j2&#34;
        dest: /etc/apache2/sites-available/wordpress.conf
      notify: Reload Apache
# Enables the Apache rewrite module, necessary for WordPress
    - name: Enabling the Apache rewrite module
      shell: /usr/sbin/a2enmod rewrite
      notify: Reload Apache
# Enables the new Apache VirtualHost file and disables the default one
    - name: Enabling the new site in Apache
      shell: /usr/sbin/a2ensite wordpress.conf
      notify: Reload Apache

    - name: Disabling the default Apache site
      shell: /usr/sbin/a2dissite 000-default.conf
      notify: Restart Apache
</code></pre></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/ResetSmith/ResetSmith.github.io/edit/main/content/posts/ansible/wordpress_deploy/index.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>
Improve this page</a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/wordpress/lamp/ title="Setting up a LAMP server for WordPress" class="btn btn-outline-info"><div><i class="fas fa-chevron-circle-left"></i> Prev</div><div class=next-prev-text>Setting up a LAMP server for WordPress</div></a></div><div class="col-md-6 next-article"><a href=/posts/monitoring/prom_install/ title="Prometheus: Getting started with Prometheus and Grafana" class="btn btn-outline-info"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>Prometheus: Getting started with Prometheus and Grafana</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#wp_installyml-playbook>wp_install.yml playbook</a></li></ul></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><a href="mailto:Reset_Smith@resettech.net?subject=&cc=&bcc=&body=">Reset_Smith@resettech.net</a></div><div class="col-md-4 col-sm-12"><h5>Images provided by:</h5><ul><li><a href=https://www.freepik.com>www.Freepik.com</a></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_3.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">© 2021 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script>
<script type=text/javascript src=/js/popper.min.js></script>
<script type=text/javascript src=/js/bootstrap.min.js></script>
<script type=text/javascript src=/js/navbar.js></script>
<script type=text/javascript src=/js/plyr.js></script>
<script type=text/javascript src=/js/main.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script>
<script src=/js/single.js></script>
<script>hljs.initHighlightingOnLoad()</script></body></html>