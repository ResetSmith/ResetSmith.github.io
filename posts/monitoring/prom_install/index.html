<!doctype html><html><head><title>Prometheus: Getting started with Prometheus and Grafana</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/css/bootstrap.min.css><link rel=stylesheet href=/css/layouts/main.css><link rel=stylesheet href=/css/navigators/navbar.css><link rel=stylesheet href=/css/plyr.css><link rel=stylesheet href=/css/flag-icon.min.css><link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><meta property="og:title" content="Prometheus: Getting started with Prometheus and Grafana"><meta property="og:description" content="Prometheus is an open-source application created for systems monitoring and alerting. The Prometheus server application can produce limited visualizations of data that it collects and stores from Exporters which send it the data. Prometheus and it&rsquo;s Exporters are good for measuring numerical values over time, things such as: Data Storage/Memory Usage, Network Stats, and Process Monitoring.
  An example of Prometheus Black Box Exporter data displayed through a Grafana dashboard"><meta property="og:type" content="article"><meta property="og:url" content="https://resettech.net/posts/monitoring/prom_install/"><meta property="article:published_time" content="2021-11-05T00:00:00+00:00"><meta property="article:modified_time" content="2021-11-05T00:00:00+00:00"><meta name=description content="Prometheus: Getting started with Prometheus and Grafana"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/css/layouts/single.css><link rel=stylesheet href=/css/navigators/sidebar.css><link rel=stylesheet href=/css/style.css><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','G-KLVVMMV4CY','auto');ga('send','pageview');}</script></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/>Reset_Smith's Blog</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse lang-selector" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><form class=mx-auto method=get action=/search><input type=text name=keyword placeholder=Search data-search id=search-box></form><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><i class="fas fa-plus-circle"></i><a href=/posts/server_mgmt/>Server Management</a><ul><li><a href=/posts/server_mgmt/htpasswd/ title="Basic Auth with Apache">Basic Auth with Apache</a></li><li><a href=/posts/server_mgmt/add_ssl/ title="Enabling SSL">Enabling SSL</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/wordpress/>WordPress</a><ul><li><a href=/posts/wordpress/lamp_22/ title="Deploying a LAMP server Ubuntu 22.04">Deploying a LAMP server Ubuntu 22.04</a></li><li><a href=/posts/wordpress/migration/ title="WordPress Migrations">WordPress Migrations</a></li><li><a href=/posts/wordpress/lamp/ title="Deploying a LAMP server Ubuntu 20.04">Deploying a LAMP server Ubuntu 20.04</a></li></ul></li><li><i class="fas fa-plus-circle"></i><a href=/posts/ansible/>Ansible</a><ul><li><a href=/posts/ansible/ansible/ title="Why Ansible">Why Ansible</a></li><li><a href=/posts/ansible/wordpress_deploy/ title="WordPress Ansible Deployment">WordPress Ansible Deployment</a></li></ul></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/monitoring/>Monitoring</a><ul class=active><li><a class=active href=/posts/monitoring/prom_install/ title="Getting started">Getting started</a></li><li><a href=/posts/monitoring/node_exporter/ title="Node exporter">Node exporter</a></li><li><a href=/posts/monitoring/blackbox/ title="Blackbox exporter">Blackbox exporter</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(https://resettech.net/posts/monitoring/prom_install/5985256.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/authors/reset_smith_hua4f6218794f907357bf1ed85aa384e41_361770_120x120_fit_q75_box.jpg alt="Author Image"><h5 class=author-name>Reset_Smith</h5><p>November 5, 2021</p></div><div class=title><h1>Prometheus: Getting started with Prometheus and Grafana</h1></div><div class=post-content id=post-content><hr><p><a href=https://prometheus.io/>Prometheus</a> is an open-source application created for systems monitoring and alerting. The Prometheus server application can produce limited visualizations of data that it collects and stores from Exporters which send it the data. Prometheus and it&rsquo;s Exporters are good for measuring numerical values over time, things such as: Data Storage/Memory Usage, Network Stats, and Process Monitoring.</p><figure><img src=grafana_ex_anon.png alt="Example of a screen showing Prometheus data displayed by a Grafana dashboard."><figcaption><p>An example of Prometheus Black Box Exporter data displayed through a Grafana dashboard</p></figcaption></figure><p>Prometheus is often paired with the open-source visualization software <a href=https://grafana.com>Grafana</a> which improves the end-user experience by making queries easier and better looking. In addition to the visualization app, Grafana also makes a log aggregation system called <a href=https://grafana.com/oss/loki/>Loki</a>. Loki is a powerful tool for monitoring activity on remote servers and makes identifiying possible issues or threats much easier.</p><p>Through this article series I&rsquo;ll go through setting up a Prometheus server on a remote VPS (In this case a &lsquo;droplet&rsquo; on DigitalOcean). The series will cover Installing Prometheus, Installing Grafana, Installing Node Exporter on both local and remote sources, Installing Black Box locally, Installing Loki, and Finally Installing Promtail on both local and remote sources. After following the tutorials in this series you will end up with a monitoring dashboard that looks something like the examples shown.</p><figure><img src=grafana_ex2_anon.png alt="Prometheus Node Exporter data displayed through a Grafana dashboard."><figcaption><p>An example of data from the Prometheus Node Exporter displayed by a Grafana dashboard.</p></figcaption></figure><h2 id=getting-started>Getting Started</h2><p><em>For the purposes of this article you will need SSH access to a VPS or local machine running Ubuntu 20.04 LTS</em></p><p>There are a few different ways to handle getting Prometheus started. The easiest way to get going quickly is to use Prometheus as a Docker image, Prometheus has <a href=https://prometheus.io/docs/prometheus/latest/installation/>instructions on it&rsquo;s website</a> for doing this if you would like to go that route. For the purposes of this article I&rsquo;ll go through installing Prometheus &lsquo;locally&rsquo;, locally in this instance refers to a DigitalOcean VPS. I&rsquo;ll use this setup for the rest of this series so if you do something different your experience may differ slightly.</p><div class="alert alert-info"><strong>DigitalOcean VPS</strong><br>For this article I am installing Prometheus on a DigitalOcean 2vCPU, 4GB Memory Droplet. Prometheus seems to have relatively low memory usage compared to other monitoring apps I tried (looking at you Elastic), you should be able to follow these directions on any comparable Cloud VPS running Ubuntu 20.04 or with a bit of &lsquo;fanagaling&rsquo; the Debian equivalent.</div><hr><h2 id=installing-prometheus>Installing Prometheus</h2><p>To install Prometheus we&rsquo;ll first create a new user on our server to run the app, and create some necessary folders, then grant the correct permissions. From there we&rsquo;ll download Prometheus and move it to the correct location to run from, setup a config file, and then create a service to run the app.</p><h3 id=creating-a-user-account>Creating a user account</h3><p>We&rsquo;ll start with creating a user named &lsquo;prometheus&rsquo;.</p><pre><code>sudo useradd -rs /bin/false prometheus
</code></pre><p>The &lsquo;-rs /bin/false&rsquo; modifier defines this user as a &lsquo;system&rsquo; account, and setting the shell as /bin/false prevents this user from being logged into.</p><p>Next let&rsquo;s make the folders Prometheus will need and assign their ownership to the prometheus user and group.</p><pre><code>sudo mkdir /etc/prometheus
sudo mkdir /var/lib/prometheus
sudo chown prometheus:prometheus /etc/prometheus
sudo chown prometheus:prometheus /var/lib/prometheus
</code></pre><h3 id=download-prometheus>Download Prometheus</h3><p><em>At the time of this article the most recent Prometheus version is 2.31.1, however you should check the Prometheus website <a href=https://prometheus.io/download/>downloads section</a> for the most recent version.</em></p><p>With the user made and the folders in place we&rsquo;re ready to download Prometheus. For this we&rsquo;ll navigate to the /tmp folder, download Prometheus, uncompress the tarball, move the files to their correct locations on the server, and then update the permissions to grant access to our &lsquo;prometheus&rsquo; user and group.</p><pre><code>cd /tmp

wget https://github.com/prometheus/prometheus/releases/download/v2.31.1/prometheus-2.31.1.linux-amd64.tar.gz
tar -xzvf prometheus-2.31.1.linux-amd64.tar.gz prometheus/

sudo mv prometheus/prometheus /usr/local/bin/
sudo mv prometheus/promtool /usr/local/bin/

sudo chown prometheus:prometheus /usr/local/bin/prometheus
sudo chown prometheus:prometheus /usr/local/bin/prometheus
</code></pre><h3 id=configure-prometheus>Configure Prometheus</h3><p>To make Prometheus work we need to define a configuration file. This file will define some of Prometheus' general settings as well as how, which, and where the Exporters are that Prometheus should listen to.</p><p>First create the configuration file.</p><pre><code>sudo vim /etc/prometheus/prometheus.yml
</code></pre><p>Here is a basic configuration to get us started, it will pull the basic metrics that Prometheus itself collects. Later this can be expanded on to add additional Exporters to monitor. Copy what&rsquo;s below into the prometheus.yml file.</p><pre><code>global:
  scrape_interval:     15s
  evaluation_interval: 15s

rule_files:
  # - &quot;first.rules&quot;
  # - &quot;second.rules&quot;

scrape_configs:
  - job_name: 'prometheus'
    scrape_interval: 5s
    static_configs:
      - targets: ['localhost:9090']
</code></pre><p>The Prometheus configuration file has quite a few options, you can see them all in the <a href=https://prometheus.io/docs/prometheus/latest/configuration/configuration/>Prometheus configuration documentation</a>. We&rsquo;ll start with this simple configuration for now, and add on to this throughout this series.</p><p>Next we need to update the permissions of the configuration file for our &lsquo;prometheus&rsquo; user and group.</p><pre><code>sudo chown prometheus:prometheus /etc/prometheus/prometheus.yml
</code></pre><h3 id=setup-a-service-to-run-prometheus>Setup a service to run Prometheus</h3><p>With the other pieces in place we&rsquo;re ready to create a service to handle running the Prometheus app. The service will tell Ubuntu which user to use when running Prometheus as well as tell Prometheus where it can find the configuration file and the data to monitor. Create the service file with the following command.</p><pre><code>sudo touch /etc/systemd/system/prometheus.service
</code></pre><p>Fill in the prometheus.service file with what&rsquo;s below.</p><pre><code>[Unit]
Description=Prometheus Monitoring
Wants=network-online.target
After=network-online.target

[Service]
User=prometheus
Group=prometheus
Type=simple
ExecStart=/usr/local/bin/prometheus \
--config.file /etc/prometheus/prometheus.yml \
--storage.tsdb.path /var/lib/prometheus/ \

ExecReload=/bin/kill -HUP $MAINPID

[Install]
WantedBy=multi-user.target
</code></pre><p>Now Prometheus should be ready to run. First we&rsquo;ll get the Prometheus service running.</p><pre><code>sudo systemctl start prometheus.service
</code></pre><p>Then we should check if there are any errors with what we have done so far.</p><pre><code>sudo systemctl status prometheus.service
</code></pre><p>If the status update returns an error code, you&rsquo;ll need to retrace your steps and fix the issue before continuing. If the status comes back &lsquo;active&rsquo; then we should be set to &lsquo;enable&rsquo; the service. Enabling the service sets it so that it will automatically restart when the server does.</p><pre><code>sudo systemctl enable prometheus.service
</code></pre><p>We should now have an operating Prometheus app, accessible through it&rsquo;s default of http://localhost:9090.</p><h3 id=opening-the-firewall>Opening the firewall</h3><p>If you are using a firewall app to secure your server (You should be) you will need to open port 9090 to TCP traffic. You can do this with UFW with the following command.</p><pre><code>sudo ufw allow 9090
</code></pre><hr><h2 id=installing-grafana>Installing Grafana</h2><p>Like Prometheus, Grafana has a couple of different options for installation including a hosted cloud option that will avoid having to go through all of this if you wish. However, we are interested in the &lsquo;self-managed&rsquo; version of Grafana, specifically we will be using the &lsquo;Enterprise Edition&rsquo;.</p><p>For our purposes we will be using the option to install Grafana from the APT repository. This will allow Grafana to be updated in the future using the &lsquo;apt update/upgrade&rsquo; command instead of having to download and reinstall from the web.</p><p>Lets start with installing the necessary dependencies for Grafana.</p><pre><code>sudo apt-get install -y apt-transport-https
sudo apt-get install -y software-properties-common wget
</code></pre><p>Now we add Grafana Enterprise stable release to the apt repository.</p><pre><code>wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -
echo &quot;deb https://packages.grafana.com/enterprise/deb stable main&quot; | sudo tee -a /etc/apt/sources.list.d/grafana.list
</code></pre><p>And then we can update the apt repository list and install Grafana.</p><pre><code>sudo apt-get update
sudo apt-get install grafana-enterprise
</code></pre><h3 id=setup-a-service-for-grafana>Setup a service for Grafana</h3><p>Just like with Prometheus we need to create a service that will keep Grafana running.</p><p>This first command tells systemctl to check for new services.</p><pre><code>sudo systemctl daemon-reload
</code></pre><p>Next lets start the Grafana service and then check if it&rsquo;s working Ok.</p><pre><code>sudo systemctl start grafana-server
sudo systemctl status grafana-server
</code></pre><p>If the status comes back &lsquo;active&rsquo; then we are good to enable the service.</p><pre><code>sudo systemctl enable grafana-server
</code></pre><h3 id=opening-the-firewall-1>Opening the Firewall</h3><p>From here we should be able to now see our Grafana instance available at http://localhost:3000. If the server/website is not available you may need to open port 3000 on your Firewall to TCP traffic.</p><pre><code>sudo ufw allow 3000
</code></pre><p>The default user should be admin/admin, you should update this as soon as you get into Grafana. For the time being this is only accessible via URL:Port, in a future article I will cover creating a reverse proxy with Apache to route traffic to Grafana via a subdomain.</p><hr><h2 id=installing-node-exporter>Installing Node Exporter</h2><p><a href=https://github.com/prometheus/node_exporter>Node Exporter</a> is one of the many premade exporters available for Prometheus. Node Exporter is a hardware and OS metrics tool for Linux, that uses &lsquo;collectors&rsquo; to pull metrics from it&rsquo;s host machine and then make them available for a scrapper to come along and pull. Node Exporter will typically be installed on a host machine that you would want to monitor, we&rsquo;ll be installing it on the same machine we installed Prometheus on in this example. Installing Node Exporter on a remote machine will be covered in a future article.</p><h3 id=create-a-user>Create a User</h3><p>Like with Prometheus we will first create a system user account for Node Exporter to use. The user will be named &lsquo;exporter&rsquo; and we&rsquo;ll use the same -rs /bin/exporter to create the account. From there we&rsquo;ll make a folder for the Node Exporter app and another for the config file, then we&rsquo;ll give permissions to these folders to the exporter user and group.</p><pre><code>sudo useradd -rs /bin/false exporter

sudo mkdir /usr/local/bin/node_exporter
sudo mkdir /etc/prometheus/node_exporter

sudo chown -R exporter:exporter /usr/local/bin/node_exporter
sudo chown -R exporter:exporter /etc/prometheus/node_exporter
sudo chmod -R 777 /usr/local/bin/node_exporter
sudo chmod -R 777 /etc/prometheus/node_exporter

</code></pre><h3 id=download-node-exporter>Download Node Exporter</h3><p><em>At the time of this article the most recent Node Exporter version is 1.2.2, however you should check the Prometheus website <a href=https://prometheus.io/download/#node_exporter>downloads section</a> for the most recent version.</em></p><p>Next we&rsquo;ll download the Node Exporter app. Navigate to the /tmp folder, download the Node Exporter, uncompress the tarball file, move the Node Exporter app to it&rsquo;s working directory, and the navigate back to your &lsquo;home&rsquo; folder.</p><pre><code>cd /tmp
curl -O -L https://github.com/prometheus/node_exporter/releases/download/v1.2.2/node_exporter-1.2.2.linux-amd64.tar.gz
tar xzvf node_exporter-*.*-amd64.tar.gz
sudo mv node_exporter-*.*-amd64 /usr/local/bin/node_exporter
cd
</code></pre><h3 id=setup-up-a-service-to-run-node-exporter>Setup up a service to run Node Exporter</h3><p>From here we&rsquo;ll create the Node Exporter service file.</p><pre><code>sudo vim /etc/systemd/system/node_exporter.service
</code></pre><p>And then we&rsquo;ll fill that in with the text below.</p><pre><code>[Unit]
Description=Node exporter for Prometheus
After=network.target

[Service]
User=exporter
Type=simple
ExecStart=/usr/local/bin/node_exporter/node_exporter

[Install]
WantedBy=multi-user.target
</code></pre><p>We can now start our Node Exporter service. Like with Prometheus we&rsquo;ll start the Node Exporter service and then check if it&rsquo;s running properly.</p><pre><code>sudo systemctl start node_exporter.service
sudo systemctl status node_exporter.service
</code></pre><p>If the service returns &lsquo;active&rsquo; then we can move forward with enabling it.</p><pre><code>sudo systemctl enable node_exporter.service
</code></pre><h3 id=add-node-exporter-to-prometheus>Add Node Exporter to Prometheus</h3><p>Finally we&rsquo;ll go ahead and add a job within our Prometheus configuration file to scrape data from Node Exporter. Open the prometheus.yml and then add the following to the end.</p><pre><code>- job_name: 'node_exporter'
  scrape_interval: 5s
  static_configs:
    - targets: ['localhost:9100']
</code></pre><p>In .yml files the spacing is important so make sure the spacing matches up properly with the &lsquo;prometheus&rsquo; job that&rsquo;s already there. The final configuration file should read like this</p><pre><code>global:
  scrape_interval:     15s
  evaluation_interval: 15s

rule_files:
  # - &quot;first.rules&quot;
  # - &quot;second.rules&quot;

scrape_configs:
  - job_name: 'prometheus'
    scrape_interval: 5s
    static_configs:
      - targets: ['localhost:9090']
  - job_name: 'node_exporter'
    scrape_interval: 5s
    static_configs:
      - targets: ['localhost:9100']
</code></pre><p>Now we can log back into our Grafana server at http://localhost:3000 and then add our Node Exporter as a data source.</p><ul><li>From the sidebar click on the + icon</li><li>in &lsquo;settings&rsquo; go to &lsquo;data sources&rsquo;</li><li>select &lsquo;Add data source&rsquo;</li><li>select &lsquo;Node Exporter&rsquo;</li><li>set the URL to the URL of prometheus localhost:9090</li><li>Save & Test</li><li>add dashboard - 1860</li></ul></div><div class="row pl-3 pr-3"><div class="col-md-6 share-buttons"></div><div class="col-md-6 btn-improve-page"><a href=https://github.com/ResetSmith/ResetSmith.github.io/edit/main/content/posts/monitoring/prom_install/index.md title="Improve this page" target=_blank rel=noopener><i class="fas fa-code-branch"></i>Improve this page</a></div></div><hr><div class="row next-prev-navigator"><div class="col-md-6 previous-article"><a href=/posts/ansible/wordpress_deploy/ title="Ansible: Automate your WordPress deployments" class="btn btn-outline-info"><div><i class="fas fa-chevron-circle-left"></i>Prev</div><div class=next-prev-text>Ansible: Automate your WordPress deployments</div></a></div><div class="col-md-6 next-article"><a href=/posts/monitoring/node_exporter/ title="Prometheus: Installing the Node exporter" class="btn btn-outline-info"><div>Next <i class="fas fa-chevron-circle-right"></i></div><div class=next-prev-text>Prometheus: Installing the Node exporter</div></a></div></div><hr></div></div></div><a id=scroll-to-top class=btn><i class="fas fa-chevron-circle-up"></i></a></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#getting-started>Getting Started</a></li><li><a href=#installing-prometheus>Installing Prometheus</a></li><li><a href=#installing-grafana>Installing Grafana</a></li><li><a href=#installing-node-exporter>Installing Node Exporter</a></li></ul></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul></ul></div><div class="col-md-4 col-sm-12"><h5>Contact me:</h5><a href="mailto:Reset_Smith@resettech.net?subject=&cc=&bcc=&body=">Reset_Smith@resettech.net</a></div><div class="col-md-4 col-sm-12"><h5>Images provided by:</h5><ul><li><a href=https://www.freepik.com>www.Freepik.com</a></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=_blank rel=noopener><img src=/images/theme-logo_hu8376fd15465fef26ffe66b6bcf0ca686_13669_32x0_resize_box_2.png alt="Toha Theme Logo">
Toha</a></div><div class="col-md-4 text-center">Â© 2021 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/ target=_blank rel=noopener>Powered by
<img src=/images/hugo-logo.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script type=text/javascript src=/js/jquery-3.4.1.min.js></script><script type=text/javascript src=/js/popper.min.js></script><script type=text/javascript src=/js/bootstrap.min.js></script><script type=text/javascript src=/js/navbar.js></script><script type=text/javascript src=/js/plyr.js></script><script type=text/javascript src=/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script><script src=/js/single.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>